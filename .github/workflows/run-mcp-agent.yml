name: Run MCP + OpenAI from Source

on:
  workflow_dispatch:

jobs:
  agent-runner:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clone and Build MCP from GitHub
        run: |
          git clone https://github.com/microsoft/playwright-mcp.git
          cd playwright-mcp
          npm install
          npm run build || (echo "ðŸ”´ MCP build failed" && exit 1)
          test -f dist/index.js || (echo "âŒ dist/index.js was not created" && exit 1)
          npm install openai dotenv

      - name: Write agent-runner script into MCP folder (via base64 decode)
        run: |
          echo "aW1wb3J0IHsgTUNQU2VydmVyLCBNQ1BDbGllbnQgfSBmcm9tICIuL2Rpc3QvaW5kZXguanMiOwppbXBvcnQgT3BlbkFJIGZyb20gIm9wZW5haSI7CmltcG9ydCAqIGFzIGRvdGVudiBmcm9tICJkb3RlbnYiOwpkb3RlbnYuY29uZmlnKCk7Cgpjb25zdCBvcGVuYWkgPSBuZXcgT3BlbkFJKHthcGlLZXk6IHByb2Nlc3MuZW52Lk9QRU5BSV9BUElfS0VZIH0pOwpjb25zdCBJTlNUUlVDVElPTiA9IHByb2Nlc3MuYXJndlsxXTsKCmNvbnN0IHJ1biA9IGFzeW5jICgpID0+IHsKICBjb25zdCBzZXJ2ZXIgPSBhd2FpdCBNQ1BTZXJ2ZXIubGF1bmNoKCk7CiAgY29uc3QgY2xpZW50ID0gYXdhaXQgTUNQQ2xpZW50LmNvbm5lY3Qoc2VydmVyLndzRW5kcG9pbnQoKSk7CgogIGF3YWl0IGNsaWVudC5wYWdlLmdvdG8oImh0dHBzOi8vZ2l0aHViLmNvbS9EYXRhRG9nL2hlbG0tY2hhcnRzL3JlbGVhc2VzIik7CiAgY29uc3Qgc25hcHNob3QgPSBhd2FpdCBjbGllbnQucGFnZS5hY2Nlc3NpYmlsaXR5LnNuYXBzaG90KCk7CgogIGNvbnN0IGNoYXQgPSBhd2FpdCBvcGVuYWkuY2hhdC5jb21wbGV0aW9ucy5jcmVhdGUoewogICAgbW9kZWw6ICJncHQtNCIsCiAgICBtZXNzYWdlczogWwogICAgeyByb2xlOiAic3lzdGVtIiwgY29udGVudDogIllvdSBhcmUgYSBoZWxwZnVsIGJyb3dzZXIgYWdlbnQuIiB9LAogICAgeyByb2xlOiAidXNlciIsIGNvbnRlbnQ6ICJJbnN0cnVjdGlvbjogIiArIElOU1RSVUNUSU9OICsgIlxcblxcbk5hcHNob3Q6ICIgKyBKU09OLnN0cmluZ2lmeShzbmFwc2hvdCkuc2xpY2UoMCwgMTIwMDApICsgIi4uLiIgfQogICAgXQogIH0pOwoKICBjb25zb2xlLmxvZygi8J+YjCBHUFQtNCBPdXRwdXQ6XG4iLCBjaGF0LmNob2ljZXNbMF0ubWVzc2FnZS5jb250ZW50KTsKICBhd2FpdCBjbGllbnQuY2xvc2UoKTsKICBhd2FpdCBzZXJ2ZXIuY2xvc2UoKTsKfTsKCnJ1bigpOw==" | base64 -d > playwright-mcp/agent-runner.mjs

      - name: Run MCP agent
        run: |
          cd playwright-mcp
          node agent-runner.mjs "Get the latest release tag from https://github.com/DataDog/helm-charts"
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
